################################################################################################
### Production configuration for OpenRouteService - United States                            ###
### For documentation visit: https://giscience.github.io/openrouteservice/run-instance/configuration/
################################################################################################

##### General server settings #####
server:
  port: 8082
  error:
    whitelabel:
      enabled: false
  servlet:
    context-path: /ors
  tomcat:
    keep-alive-timeout: 30000
    # Reduce Tomcat memory footprint during graph building
    # Smaller thread pools = less memory usage
    threads:
      max: 50 # Reduced from default to save memory during build
      min-spare: 5 # Reduced from default
    max-connections: 100 # Limit connections to reduce memory
    accept-count: 50 # Smaller accept queue

spring:
  profiles:
    active: default
  mvc:
    servlet:
      path: /

##### Settings related to springdoc #####
springdoc:
  # Disable Swagger UI during build to save memory
  # Can enable after graphs are built
  swagger-ui:
    enabled: false
    path: /swagger-ui
    tryItOutEnabled: false
    filter: false
    syntaxHighlight:
      activated: false
    showExtensions: false
  api-docs:
    path: /v2/api-docs
    version: OPENAPI_3_0
  packages-to-scan: org.heigit.ors
  pathsToMatch: /v2/**

##### Logging settings #####
logging:
  file:
    name: ./logs/ors.log
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss} %highlight{%-7p} %style{%50t}{Cyan} %style{[ %-40.40c{1.} ]}{Bright Cyan}   %m%n"
    file: "%d{yyyy-MM-dd HH:mm:ss} %p [%-40.40c{1.}] - %m%n"
  level:
    root: WARN
    org.heigit: INFO

##### openrouteservice specific settings #####
ors:
  cors:
    allowed_origins: "*"
    allowed_headers: Content-Type, X-Requested-With, accept, Origin, Access-Control-Request-Method, Access-Control-Request-Headers, Authorization
    preflight_max_age: 600

  ##### ORS endpoints settings #####
  endpoints:
    routing:
      enabled: true
      attribution: openrouteservice.org, OpenStreetMap contributors
      gpx_name: ORSRouting
      gpx_description: This is a directions instructions file as GPX, generated from openrouteservice
      gpx_base_url: https://openrouteservice.org/
      gpx_support_mail: support@openrouteservice.org
      gpx_author: openrouteservice
      gpx_content_licence: LGPL 3.0
      maximum_avoid_polygon_area: 200000000
      maximum_avoid_polygon_extent: 20000
      maximum_alternative_routes: 3
    matrix:
      enabled: true
      attribution: openrouteservice.org, OpenStreetMap contributors
      maximum_routes: 2500
      maximum_routes_flexible: 25
      maximum_visited_nodes: 100000
      maximum_search_radius: 2000
      u_turn_costs: -1
    isochrones:
      enabled: true
      attribution: openrouteservice.org, OpenStreetMap contributors
      maximum_locations: 2
      maximum_intervals: 1
      allow_compute_area: true
      maximum_range_distance_default: 50000
      maximum_range_distance:
        - profiles: driving-car, driving-hgv
          value: 100000
      maximum_range_time_default: 18000
      maximum_range_time:
        - profiles: driving-car, driving-hgv
          value: 3600
      fastisochrones:
        maximum_range_distance_default: 50000
        maximum_range_distance:
          - profiles: driving-car, driving-hgv
            value: 500000
        maximum_range_time_default: 18000
        maximum_range_time:
          - profiles: driving-car, driving-hgv
            value: 10800
    snap:
      enabled: true
      attribution: openrouteservice.org, OpenStreetMap contributors
      maximum_locations: 5000
    match:
      enabled: true
      maximum_search_radius: 500
      attribution: openrouteservice.org, OpenStreetMap contributors
    export:
      enabled: true
      attribution: openrouteservice.org, OpenStreetMap contributors

  ##### ORS engine settings #####
  engine:
    init_threads: 1
    preparation_mode: false
    # Use MMAP instead of RAM_STORE to reduce heap memory usage
    # MMAP uses memory-mapped files (off-heap) instead of loading everything into Java heap
    # This significantly reduces heap requirements, especially for large datasets like US
    graphs_data_access: MMAP
    dynamic_data:
      enabled: false
    elevation:
      preprocessed: false
      data_access: MMAP
      cache_clear: false
      provider: multi
      cache_path: elevation_cache
    profile_default:
      enabled: false
      graph_path: graphs
      build:
        source_file: /home/ors/files/california-latest.osm.pbf # California OSM PBF file location (smaller, works with 32GB RAM)
        # Disable elevation to reduce memory usage (enable only if you need elevation data)
        # Elevation data significantly increases memory requirements for large areas like US
        elevation: false
        elevation_smoothing: false
        # Reduced encoder flags size to save memory (4 bits instead of 8)
        encoder_flags_size: 4
        # Disable instructions during build to save memory (can enable after build)
        instructions: false
        optimize: false # Keep disabled to save memory during build
        traffic: false
        maximum_speed_lower_bound: 80
        # Increased resolution (lower precision) to reduce memory usage
        # Higher number = lower precision = less memory
        location_index_resolution: 1000
        # Reduced search iterations to save memory
        location_index_search_iterations: 2
        interpolate_bridges_and_tunnels: true
        preparation:
          min_network_size: 200
          methods:
            # Disable LM preparation during build to save memory
            # Can enable after graphs are built if needed
            lm:
              enabled: false
              threads: 1
              weightings: recommended
              landmarks: 8 # Reduced if enabled
      service:
        maximum_distance: 100000
        maximum_distance_dynamic_weights: 100000
        maximum_distance_avoid_areas: 100000
        maximum_waypoints: 50
        maximum_snapping_radius: 400
        maximum_distance_alternative_routes: 100000
        maximum_distance_round_trip_routes: 100000
        maximum_visited_nodes: 1000000
        force_turn_costs: false
        allow_custom_models: true
        execution:
          methods:
            lm:
              active_landmarks: 8

    ##### Profile specific settings #####
    profiles:
      # Driving Car Profile - Primary profile for US routing
      driving-car:
        enabled: true
        encoder_name: driving-car
        build:
          encoder_options:
            turn_costs: true # Keep enabled (needed for accurate routing)
            block_fords: false
            # Disable acceleration to save memory
            use_acceleration: false
            enable_custom_models: false
          preparation:
            min_network_size: 200
            methods:
              # Keep CH enabled (needed for routing)
              ch:
                enabled: true
                threads: 1
                weightings: fastest
              lm:
                enabled: false
              # Disable Core preparation during build to save significant memory
              # Can enable after graphs are built if you need Core routing
              core:
                enabled: false
                threads: 1
                weightings: fastest
                landmarks: 32 # Reduced if enabled
                lmsets: highways
          # Disable non-essential ext_storages to save memory
          # Keep only what's essential for basic routing
          ext_storages:
            # WayCategory:  # Disabled to save memory
            # HeavyVehicle:  # Disabled to save memory
            # Tollways:  # Disabled to save memory
            # WaySurfaceType:  # Disabled to save memory
            # RoadAccessRestrictions:  # Disabled to save memory
          # Disable encoded values to save memory
          encoded_values:
            road_environment: false
        service:
          execution:
            methods:
              lm:
                active_landmarks: 6
              core:
                active_landmarks: 6

      # Heavy Goods Vehicle Profile - Uncomment if needed
      # driving-hgv:
      #   enabled: true
      #   encoder_name: driving-hgv
      #   build:
      #     encoder_options:
      #       turn_costs: true
      #       block_fords: false
      #       use_acceleration: true
      #       enable_custom_models: false
      #     preparation:
      #       min_network_size: 200
      #       methods:
      #         ch:
      #           enabled: true
      #           threads: 1
      #           weightings: recommended
      #         core:
      #           enabled: true
      #           threads: 1
      #           weightings: recommended,shortest
      #           landmarks: 64
      #           lmsets: highways;allow_all
      #     ext_storages:
      #       WayCategory:
      #       HeavyVehicle:
      #         restrictions: true
      #       Tollways:
      #       WaySurfaceType:
      #   service:
      #     execution:
      #       methods:
      #         core:
      #           active_landmarks: 6
