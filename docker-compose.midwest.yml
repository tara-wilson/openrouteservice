# Docker Compose file for OpenRouteService - US Midwest Region
# Runs on port 8084
# Includes: Illinois, Ohio, Michigan, Indiana, etc.

services:
  ors-app-midwest:
    build:
      context: ./
      target: publish
    container_name: ors-app-midwest
    restart: unless-stopped
    ports:
      - "8084:8082"
      - "9005:9001"
    image: local/openrouteservice:latest
    volumes:
      - ./ors-docker:/home/ors
    environment:
      REBUILD_GRAPHS: False
      CONTAINER_LOG_LEVEL: INFO
      ORS_CONFIG_LOCATION: /home/ors/config/ors-config-midwest.yml
      PARALLEL_GC_THREADS: 2
      XMS: 12g
      XMX: 20g
      ADDITIONAL_JAVA_OPTS: "-XX:+ExitOnOutOfMemoryError -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=/home/ors/logs/heapdump-midwest.hprof -XX:MaxGCPauseMillis=200 -XX:G1HeapRegionSize=16m -XX:InitiatingHeapOccupancyPercent=40 -XX:ConcGCThreads=4 -XX:ParallelGCThreads=2 -XX:+UseStringDeduplication -XX:MaxDirectMemorySize=2g -XX:ReservedCodeCacheSize=256m -XX:InitialCodeCacheSize=64m"
    deploy:
      resources:
        limits:
          memory: 22g
        reservations:
          memory: 12g
    healthcheck:
      test: wget --no-verbose --tries=1 --spider http://localhost:8082/ors/v2/health || exit 1
      start_period: 5m
      interval: 30s
      timeout: 5s
      retries: 3
      disable: false

